name: Auto Sync Fork (Hourly, Safe)

on:
  schedule:
    - cron: '0 * * * *'  # 每小时执行一次（UTC 时间）
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout your fork
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup upstream
        run: |
          git remote remove upstream || true
          git remote add upstream https://github.com/IDA16384/-DEV.git
          git fetch upstream

      - name: Detect main branch
        id: detect
        run: |
          if git show-ref --verify --quiet refs/remotes/upstream/main; then
            echo "branch=main" >> $GITHUB_OUTPUT
          else
            echo "branch=master" >> $GITHUB_OUTPUT
          fi

      - name: Force sync with upstream
        run: |
          git checkout ${{ steps.detect.outputs.branch }} || git checkout -b ${{ steps.detect.outputs.branch }}
          git fetch upstream
          git reset --hard upstream/${{ steps.detect.outputs.branch }}
          
          # 使用 Token 认证推送
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push origin ${{ steps.detect.outputs.branch }} --force
